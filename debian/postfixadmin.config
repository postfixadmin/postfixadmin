#!/bin/sh
set -e

. /usr/share/debconf/confmodule

# Check if this is a reinstall after purge
REINSTALL_AFTER_PURGE="false"
if [ -f /var/lib/postfixadmin/.purged ]; then
	REINSTALL_AFTER_PURGE="true"
	# Remove the purge marker
	rm -f /var/lib/postfixadmin/.purged
	# Reset all setup password related debconf values
	db_reset postfixadmin/setup-password || true
	db_reset postfixadmin/setup-password-again || true
	db_fset postfixadmin/setup-password seen false || true
	db_fset postfixadmin/setup-password-again seen false || true
fi

# Ask for domain configuration
db_input medium postfixadmin/configure-domain || true
db_input low postfixadmin/configure-vacation-subdomain || true
db_input medium postfixadmin/admin-email || true

# Check if we're in non-interactive mode
if [ "$DEBIAN_FRONTEND" = "noninteractive" ]; then
    # In non-interactive mode, skip password prompts if values are already set
    # But force new password entry if this is after a purge
    db_get postfixadmin/setup-password || true
    if [ -z "$RET" ] || [ "$REINSTALL_AFTER_PURGE" = "true" ]; then
        # Set a default password if none is set or if reinstalling after purge
        db_set postfixadmin/setup-password "changeme"
        db_set postfixadmin/setup-password-again "changeme"
    fi
else
    # Ask for setup password in interactive mode only
    # Force password entry if this is a reinstall after purge
    if [ "$REINSTALL_AFTER_PURGE" = "true" ]; then
        db_input critical postfixadmin/post-purge-reinstall || true
        db_go
    fi
    
    while true; do
        # Ask for passwords
        db_input high postfixadmin/setup-password || true
        db_input high postfixadmin/setup-password-again || true
        db_go
        
        # Get the passwords
        db_get postfixadmin/setup-password
        PASSWORD1="$RET"
        db_get postfixadmin/setup-password-again
        PASSWORD2="$RET"
        
        # Check if passwords match and meet requirements
        if [ -z "$PASSWORD1" ]; then
            db_input critical postfixadmin/password-empty || true
            db_go
            continue
        fi
        
        if [ ${#PASSWORD1} -lt 5 ]; then
            db_input critical postfixadmin/password-too-short || true
            db_go
            continue
        fi
        
        if [ "$PASSWORD1" != "$PASSWORD2" ]; then
            db_input critical postfixadmin/password-mismatch || true
            db_go
            # Reset password fields
            db_reset postfixadmin/setup-password
            db_reset postfixadmin/setup-password-again
            continue
        fi
        
        # Passwords are valid, break out of loop
        break
    done
fi

db_go

if [ -f /usr/share/dbconfig-common/dpkg/config ]; then
	# we support mysql and pgsql
	dbc_dbtypes="mysql, pgsql"

	. /usr/share/dbconfig-common/dpkg/config
	dbc_go postfixadmin $@
fi
